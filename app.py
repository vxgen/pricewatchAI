import streamlit as st
import pandas as pd
import data_manager as dm
from io import BytesIO
import hashlib
import difflib
import time
import json
from datetime import date
from fpdf import FPDF

st.set_page_config(page_title="Product Check App", layout="wide")

# --- CALLBACKS (Moved here to fix API Error) ---
def add_quote_item_callback(item):
    """
    Safely adds item to session state and resets the search box.
    Runs BEFORE the app reloads, preventing the StreamlitAPIException.
    """
    if 'quote_items' not in st.session_state:
        st.session_state['quote_items'] = []
    st.session_state['quote_items'].append(item)
    
    # Safely reset the search box
    st.session_state["q_search_product"] = None
    st.toast(f"Added: {item['name']}")

# --- PDF GENERATOR ---
class QuotePDF(FPDF):
    def header(self):
        self.set_font('Arial', 'B', 20)
        self.cell(80, 10, 'MSI', 0, 0, 'L') 
        self.set_font('Arial', 'B', 16)
        self.cell(110, 10, 'Quote', 0, 1, 'R')
        self.ln(5)

    def footer(self):
        self.set_y(-15)
        self.set_font('Arial', 'I', 8)
        self.cell(0, 10, 'Generated by Product Check App - MSI Confidential', 0, 0, 'C')

def create_pdf(quote_row):
    pdf = QuotePDF()
    pdf.add_page()
    pdf.set_auto_page_break(auto=True, margin=15)
    
    # Extract Data
    items = json.loads(quote_row['items_json'])
    client_name = quote_row['client_name']
    quote_id = str(quote_row['quote_id'])
    created_at = str(quote_row['created_at'])[:10]
    expire_date = str(quote_row.get('expiration_date', ''))
    
    # Recalculate Logic
    subtotal_ex_gst = 0
    total_discount = 0
    
    for item in items:
        qty = float(item.get('qty', 0))
        price = float(item.get('price', 0))
        d_val = float(item.get('discount_val', 0))
        d_type = item.get('discount_type', '%')
        
        gross = qty * price
        if d_type == '%':
            disc_amt = gross * (d_val / 100)
        else:
            disc_amt = d_val
            
        net_line = gross - disc_amt
        subtotal_ex_gst += net_line
        total_discount += disc_amt

    gst_amount = subtotal_ex_gst * 0.10
    grand_total = subtotal_ex_gst + gst_amount
    
    # --- INFO HEADER ---
    pdf.set_font('Arial', '', 10)
    right_x = 130
    pdf.set_xy(right_x, 20)
    pdf.cell(30, 6, "Quote ref:", 0, 0); pdf.cell(30, 6, quote_id, 0, 1)
    pdf.set_x(right_x)
    pdf.cell(30, 6, "Issue date:", 0, 0); pdf.cell(30, 6, created_at, 0, 1)
    pdf.set_x(right_x)
    pdf.cell(30, 6, "Expires:", 0, 0); pdf.cell(30, 6, expire_date, 0, 1)
    pdf.set_x(right_x)
    pdf.cell(30, 6, "Currency:", 0, 0); pdf.cell(30, 6, "AUD", 0, 1)
    pdf.ln(10)
    
    # --- SELLER / BUYER ---
    y_start = pdf.get_y()
    pdf.set_font('Arial', 'B', 11); pdf.cell(90, 6, "Seller", 0, 1)
    pdf.set_font('Arial', '', 10)
    pdf.cell(90, 5, "MSI Australia", 0, 1)
    pdf.cell(90, 5, "Suite 304, Level 3, 63-79 Parramatta Rd", 0, 1)
    pdf.cell(90, 5, "Silverwater, NSW 2128", 0, 1)
    
    pdf.set_xy(110, y_start)
    pdf.set_font('Arial', 'B', 11); pdf.cell(80, 6, "Buyer", 0, 1)
    pdf.set_x(110); pdf.set_font('Arial', '', 10)
    pdf.cell(80, 5, client_name, 0, 1)
    pdf.set_x(110); pdf.cell(80, 5, str(quote_row.get('client_email', '')), 0, 1)
    pdf.ln(15)
    
    # --- LINE ITEMS ---
    pdf.set_font('Arial', 'B', 12); pdf.cell(0, 10, "Line Items", 0, 1)
    
    pdf.set_font('Arial', 'B', 9); pdf.set_fill_color(245, 245, 245)
    pdf.cell(85, 8, "Item", 1, 0, 'L', True)
    pdf.cell(15, 8, "Qty", 1, 0, 'C', True)
    pdf.cell(25, 8, "Unit Price", 1, 0, 'R', True)
    pdf.cell(30, 8, "Discount", 1, 0, 'R', True)
    pdf.cell(35, 8, "Net Total", 1, 1, 'R', True)
    
    pdf.set_font('Arial', '', 9)
    for item in items:
        name = item.get('name', 'Item')
        if len(name) > 45: name = name[:42] + "..."
        qty = float(item.get('qty', 0))
        price = float(item.get('price', 0))
        d_val = float(item.get('discount_val', 0))
        d_type = item.get('discount_type', '%')
        
        gross = qty * price
        if d_type == '%':
            disc_str = f"{d_val}%"
            disc_amt = gross * (d_val / 100)
        else:
            disc_str = f"${d_val}"
            disc_amt = d_val
            
        net_total = gross - disc_amt
        
        pdf.cell(85, 8, name, 1, 0, 'L')
        pdf.cell(15, 8, str(int(qty)), 1, 0, 'C')
        pdf.cell(25, 8, f"${price:,.2f}", 1, 0, 'R')
        pdf.cell(30, 8, disc_str, 1, 0, 'R')
        pdf.cell(35, 8, f"${net_total:,.2f}", 1, 1, 'R')

    pdf.ln(5)
    
    # --- SUMMARY ---
    pdf.set_x(120)
    pdf.cell(35, 6, "Subtotal (Ex GST):", 0, 0, 'R'); pdf.cell(35, 6, f"${subtotal_ex_gst:,.2f}", 0, 1, 'R')
    pdf.set_x(120)
    pdf.cell(35, 6, "Total Discount:", 0, 0, 'R'); pdf.cell(35, 6, f"-${total_discount:,.2f}", 0, 1, 'R')
    pdf.set_x(120)
    pdf.cell(35, 6, "GST (10%):", 0, 0, 'R'); pdf.cell(35, 6, f"${gst_amount:,.2f}", 0, 1, 'R')
    pdf.set_x(120)
    pdf.set_font('Arial', 'B', 10)
    pdf.cell(35, 8, "Grand Total:", 0, 0, 'R'); pdf.cell(35, 8, f"${grand_total:,.2f}", 0, 1, 'R')
    
    return pdf.output(dest='S').encode('latin-1')

# --- AUTH HELPERS ---
def hash_pw(password):
    return hashlib.sha256(str.encode(password)).hexdigest()

def check_login(username, password):
    try: users = dm.get_users()
    except: return False, "DB Error"
    if users.empty: return False, "No users"
    hashed = hash_pw(password)
    user = users[(users['username'] == username) & (users['password'] == hashed)]
    if not user.empty: return True, user.iloc[0]['role']
    return False, "Invalid credentials"

if 'logged_in' not in st.session_state: st.session_state['logged_in'] = False
if 'user' not in st.session_state: st.session_state['user'] = ""
if 'quote_items' not in st.session_state: st.session_state['quote_items'] = []

def login_page():
    st.title("üîê Login")
    u = st.text_input("Username")
    p = st.text_input("Password", type="password")
    if st.button("Sign In"):
        success, msg = check_login(u, p)
        if success:
            st.session_state['logged_in'] = True
            st.session_state['user'] = u
            dm.log_action(u, "Login", "Success")
            st.rerun()
        else: st.error(msg)

def main_app():
    st.sidebar.title(f"User: {st.session_state['user']}")
    if st.sidebar.button("Logout"):
        st.session_state['logged_in'] = False; st.rerun()
        
    menu = st.sidebar.radio("Navigate", ["Product Search & Browse", "Quote Generator", "Upload (Direct)", "Data Update (Direct)"])
    
    if menu == "Product Search & Browse":
        st.header("üîé Product Search & Browse")
        if st.button("Refresh Database"):
            dm.get_all_products_df.clear(); st.rerun()
        
        try: df = dm.get_all_products_df()
        except: df = pd.DataFrame()
        
        tab_search, tab_browse = st.tabs(["Search (Predictive)", "Browse Full Category"])
        with tab_search:
            if not df.empty:
                def col_has_data(dataframe, col_name):
                    if col_name not in dataframe.columns: return False
                    s = dataframe[col_name].astype(str).str.strip()
                    is_empty = s.str.lower().isin(['nan', 'none', '', 'nat'])
                    return not is_empty.all()
                valid_data_cols = [c for c in df.columns if col_has_data(df, c)]
                if valid_data_cols:
                    name_col = None
                    for col in valid_data_cols:
                        if 'product' in col.lower() and 'name' in col.lower(): name_col = col; break
                    if not name_col:
                        for col in valid_data_cols:
                            if 'model' in col.lower(): name_col = col; break
                    if not name_col: name_col = valid_data_cols[0]

                    search_df = df.copy()
                    forbidden = ['price', 'cost', 'srp', 'msrp', 'rrp', 'margin', 'date', 'time', 'last_updated', 'timestamp', 'category', 'class', 'group', 'segment']
                    def make_lbl(row):
                        main = str(row[name_col]) if pd.notnull(row[name_col]) else ""
                        parts = [main.strip()]
                        for col in valid_data_cols:
                            if col == name_col: continue
                            if any(k in col.lower() for k in forbidden): continue
                            val = str(row[col]).strip()
                            if val and val.lower() not in ['nan', 'none', '']:
                                if val not in parts: parts.append(val)
                        return " | ".join(filter(None, parts))
                    search_df['Search_Label'] = search_df.apply(make_lbl, axis=1)
                    opts = sorted([x for x in search_df['Search_Label'].unique().tolist() if x])

                    c_bar, c_clear = st.columns([8, 1])
                    with c_bar:
                        sel = st.selectbox("Search", options=opts, index=None, placeholder="Type Name...", key="search_box")
                    with c_clear:
                        if st.button("Clear"): st.session_state["search_box"] = None; st.rerun()
                    
                    st.divider()
                    if sel:
                        res = search_df[search_df['Search_Label'] == sel].drop(columns=['Search_Label'])
                        for i, row in res.iterrows():
                            with st.expander(f"üì¶ {row[name_col]}", expanded=True):
                                # Display logic
                                hidden = ['price', 'cost', 'srp', 'msrp', 'rrp', 'margin']
                                all_c = res.columns.tolist()
                                price_c = [c for c in all_c if any(k in c.lower() for k in hidden)]
                                public_c = [c for c in all_c if c not in price_c]
                                for c in public_c:
                                    v = str(row[c]).strip()
                                    if v and v.lower()!='nan': st.write(f"**{c}:** {row[c]}")
                                if price_c:
                                    st.markdown("---")
                                    if st.toggle("Show Price üí∞", key=f"t_{i}"):
                                        cols = st.columns(len(price_c))
                                        for idx, p in enumerate(price_c):
                                            try: val = f"{float(row[p]):,.2f}"
                                            except: val = row[p]
                                            cols[idx].metric(p, val)
            else: st.warning("Database empty.")
        
        with tab_browse:
            try: cats = dm.get_categories()
            except: cats = []
            if cats:
                cs = st.selectbox("Category", cats)
                if not df.empty and 'category' in df.columns:
                    cd = df[df['category'] == cs]
                    if not cd.empty:
                        st.dataframe(cd, use_container_width=True)
                        out = BytesIO()
                        with pd.ExcelWriter(out) as w: cd.to_excel(w, index=False)
                        st.download_button(f"‚¨áÔ∏è Download {cs}", out.getvalue(), f"{cs}.xlsx")
                    else: st.info("No data.")
            else: st.warning("No categories.")

    elif menu == "Quote Generator":
        st.header("üìù Quotes")
        tab_create, tab_history = st.tabs(["Create New Quote", "Quote History & Downloads"])
        
        with tab_create:
            try: df = dm.get_all_products_df()
            except: df = pd.DataFrame()

            c_details, c_items = st.columns([1, 2])
            with c_details:
                st.subheader("1. Client Details")
                with st.container(border=True):
                    q_client = st.text_input("Client Name / Company", key="q_client", value=st.session_state.get('edit_client', ''))
                    q_email = st.text_input("Client Email", key="q_email", value=st.session_state.get('edit_email', ''))
                    q_date = st.date_input("Date", date.today())
                    q_expire = st.date_input("Expiration Date", date.today())
                    q_terms = st.text_area("Terms & Conditions", "Payment due within 30 days.")

            with c_items:
                st.subheader("2. Line Items")
                t_db, t_manual = st.tabs(["Search Database", "‚ûï Add Custom Item"])
                
                with t_db:
                    if not df.empty:
                        # Smart Search Logic Reused
                        valid_data_cols = [c for c in df.columns if not df[c].astype(str).str.strip().eq('').all()]
                        if valid_data_cols:
                            name_col = valid_data_cols[0]
                            for col in valid_data_cols:
                                if 'product' in col.lower() or 'model' in col.lower(): name_col = col; break
                            
                            search_df = df.copy()
                            forbidden = ['price', 'cost', 'date', 'category', 'srp', 'msrp']
                            def make_lbl(row):
                                main = str(row[name_col]) if pd.notnull(row[name_col]) else ""
                                parts = [main.strip()]
                                for col in valid_data_cols:
                                    if col == name_col: continue
                                    if any(k in col.lower() for k in forbidden): continue
                                    val = str(row[col]).strip()
                                    if val and val.lower() not in ['nan', 'none', '']:
                                        if val not in parts: parts.append(val)
                                return " | ".join(filter(None, parts))

                            search_df['Label'] = search_df.apply(make_lbl, axis=1)
                            opts = sorted(search_df['Label'].unique().tolist())
                            
                            # SELECTBOX
                            sel_lbl = st.selectbox("Find Product", options=opts, index=None, placeholder="Type Name...", key="q_search_product")
                            
                            if sel_lbl:
                                row = search_df[search_df['Label'] == sel_lbl].iloc[0]
                                price_guess = 0.0
                                price_cols = [c for c in df.columns if any(x in c.lower() for x in ['price', 'msrp', 'srp', 'cost'])]
                                for p_col in price_cols:
                                    val_raw = str(row[p_col])
                                    val_clean = val_raw.replace('A$', '').replace('$', '').replace(',', '').strip()
                                    try:
                                        if val_clean and val_clean.lower() != 'nan':
                                            price_guess = float(val_clean); break 
                                    except: continue
                                
                                c1, c2, c3, c4 = st.columns([2, 2, 2, 1])
                                # IMPORTANT: Added dynamic keys (f"{sel_lbl}") to force refresh of inputs when product changes
                                aq = c1.number_input("Qty", 1, 1000, 1, key=f"q_{sel_lbl}")
                                ap = c2.number_input("Unit Price", value=price_guess, key=f"p_{sel_lbl}")
                                ad_val = c3.number_input("Discount", 0.0, step=1.0, key=f"d_{sel_lbl}")
                                ad_type = c4.selectbox("Type", ["%", "$"], key=f"t_{sel_lbl}")
                                
                                # PREPARE ITEM DICT
                                item_to_add = {
                                    "name": str(row[name_col]),
                                    "desc": "",
                                    "qty": aq, "price": ap,
                                    "discount_val": ad_val, "discount_type": ad_type,
                                    "total": 0
                                }
                                
                                # USE CALLBACK FOR ADD BUTTON
                                st.button("Add to Quote", key="btn_add_db", on_click=add_quote_item_callback, args=(item_to_add,))

                with t_manual:
                    with st.form("manual_add", clear_on_submit=True):
                        mn = st.text_input("Product Name")
                        c1, c2, c3, c4 = st.columns([2, 2, 2, 1])
                        mq = c1.number_input("Qty", 1, 1000, 1)
                        mp = c2.number_input("Unit Price ($)", 0.0)
                        md_val = c3.number_input("Discount", 0.0)
                        md_type = c4.selectbox("Type", ["%", "$"])
                        
                        if st.form_submit_button("Add Custom Item"):
                            if mn:
                                item = {
                                    "name": mn, "desc": "Custom Item",
                                    "qty": mq, "price": mp,
                                    "discount_val": md_val, "discount_type": md_type,
                                    "total": 0
                                }
                                add_quote_item_callback(item) # Direct call inside form submit
                                st.rerun()

            st.divider()
            
            if st.session_state['quote_items']:
                q_df = pd.DataFrame(st.session_state['quote_items'])
                
                edited_df = st.data_editor(
                    q_df, num_rows="dynamic", use_container_width=True, key="editor_quote",
                    column_config={
                        "price": st.column_config.NumberColumn("Unit Price", format="$%.2f", required=True),
                        "qty": st.column_config.NumberColumn("Qty", min_value=1, step=1, required=True),
                        "discount_val": st.column_config.NumberColumn("Discount Value", min_value=0.0),
                        "discount_type": st.column_config.SelectboxColumn("Type", options=["%", "$"], required=True),
                        "total": st.column_config.NumberColumn("Net Total", format="$%.2f", disabled=True)
                    }
                )
                
                sub_ex = 0; tot_disc = 0; items_save = []
                for index, row in edited_df.iterrows():
                    q = float(row['qty']); p = float(row['price']); d = float(row['discount_val']); t = row['discount_type']
                    gross = q * p
                    disc = gross * (d/100) if t == '%' else d
                    net = gross - disc
                    sub_ex += net; tot_disc += disc
                    r = row.to_dict(); r['total'] = net
                    items_save.append(r)

                gst = sub_ex * 0.10
                grand = sub_ex + gst

                m1, m2, m3, m4 = st.columns(4)
                m1.metric("Subtotal (Ex GST)", f"${sub_ex:,.2f}")
                m2.metric("Total Discount", f"${tot_disc:,.2f}")
                m3.metric("GST (10%)", f"${gst:,.2f}")
                m4.metric("Grand Total", f"${grand:,.2f}")
                
                c_sv, c_cl = st.columns([1, 5])
                if c_sv.button("üíæ Save Quote", type="primary"):
                    if not q_client: st.error("Client Name Required")
                    else:
                        payload = {"client_name": q_client, "client_email": q_email, "total_amount": grand, "expiration_date": str(q_expire), "items": items_save}
                        dm.save_quote(payload, st.session_state['user'])
                        st.success("Saved!"); st.session_state['quote_items'] = []; time.sleep(1); st.rerun()
                if c_cl.button("Clear All"): st.session_state['quote_items'] = []; st.rerun()

        with tab_history:
            st.subheader("üìú Quote History")
            if st.button("Refresh"): dm.get_quotes.clear(); st.rerun()
            quotes_df = dm.get_quotes()
            if not quotes_df.empty:
                quotes_df = quotes_df.sort_values(by="created_at", ascending=False)
                for i, row in quotes_df.iterrows():
                    with st.expander(f"{row['created_at']} | {row['client_name']} | ${float(row['total_amount']):,.2f}"):
                        c1, c2, c3 = st.columns(3)
                        try:
                            pdf_bytes = create_pdf(row)
                            c1.download_button("üì© Download Quote (PDF)", data=pdf_bytes, file_name=f"Quote_{row['quote_id']}.pdf", mime="application/pdf")
                        except Exception as e: c1.error(f"PDF Error: {e}")
                        
                        if c2.button("‚úèÔ∏è Edit Quote", key=f"e_{row['quote_id']}"):
                            st.session_state['quote_items'] = json.loads(row['items_json'])
                            st.session_state['edit_client'] = row['client_name']
                            st.session_state['edit_email'] = row.get('client_email', '')
                            st.toast("Loaded!"); time.sleep(1)
                        if c3.button("üóëÔ∏è Delete", key=f"d_{row['quote_id']}"):
                            dm.delete_quote(row['quote_id'], st.session_state['user']); st.rerun()
            else: st.info("No quotes found.")

    elif menu == "Upload (Direct)":
        st.header("üìÇ File Upload"); c_left, c_right = st.columns([1, 1])
        with c_left:
            cats = dm.get_categories(); cat_sel = st.selectbox("Category", cats if cats else ["Default"])
        with c_right:
            new_cat = st.text_input("New Cat"); 
            if st.button("Add"): 
                if new_cat: dm.add_category(new_cat, st.session_state['user']); st.rerun()
        files = st.file_uploader("Upload", accept_multiple_files=True)
        has_h = st.checkbox("Headers?", True)
        if files:
            for f in files:
                if st.button(f"Save {f.name}"):
                    try:
                        h = 0 if has_h else None
                        df = pd.read_csv(f, header=h) if f.name.endswith('csv') else pd.read_excel(f, header=h)
                        dm.save_products_dynamic(df.dropna(how='all'), cat_sel, st.session_state['user'])
                        st.success("Saved!"); time.sleep(1); st.rerun()
                    except Exception as e: st.error(str(e))

    elif menu == "Data Update (Direct)":
        st.header("üîÑ Update"); cats = dm.get_categories(); cat_sel = st.selectbox("Category", cats)
        up = st.file_uploader("New File"); hh = st.checkbox("Headers?", True, key="uph")
        if up:
            h = 0 if hh else None
            df = pd.read_csv(up, header=h) if up.name.endswith('csv') else pd.read_excel(up, header=h)
            st.write(df.head(3))
            cols = list(df.columns); k = st.selectbox("ID Column", cols)
            if st.button("Update"):
                r = dm.update_products_dynamic(df, cat_sel, st.session_state['user'], k)
                st.success(f"New: {r['new']}, EOL: {r['eol']}")

if st.session_state['logged_in']: main_app()
else: login_page()
